# æ–‡å­—æœç´¢å›¾ç‰‡ç³»ç»Ÿ

åŸºäºŽCLIPæ¨¡åž‹å’Œå‘é‡æ•°æ®åº“å®žçŽ°çš„æ–‡å­—æœç´¢å›¾ç‰‡åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹ç‚¹

- ðŸ–¼ï¸ ä½¿ç”¨CLIPå¤šæ¨¡æ€æ¨¡åž‹å°†å›¾ç‰‡å’Œæ–‡å­—ç¼–ç ä¸ºå‘é‡
- ðŸ” æ”¯æŒç”¨è‡ªç„¶è¯­è¨€æ–‡å­—æœç´¢å›¾ç‰‡
- ðŸ’¾ ä½¿ç”¨Chromaå‘é‡æ•°æ®åº“å­˜å‚¨å’Œæ£€ç´¢å›¾ç‰‡å‘é‡
- ðŸš€ æ”¯æŒæ‰¹é‡ç´¢å¼•å’Œå¿«é€Ÿæœç´¢

## å®‰è£…ä¾èµ–

æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ chromadbï¼‰éƒ½å¯ä»¥é€šè¿‡ pip ä¸€æ¬¡æ€§å®‰è£…ï¼Œ**æ— éœ€å•ç‹¬å®‰è£…**ï¼š

```bash
pip install -r requirements.txt
```

è¿™å°†ä¼šè‡ªåŠ¨å®‰è£…ä»¥ä¸‹ä¾èµ–ï¼š
- `torch` - PyTorchæ·±åº¦å­¦ä¹ æ¡†æž¶
- `transformers` - Hugging Faceæ¨¡åž‹åº“ï¼ˆåŒ…å«CLIPæ¨¡åž‹ï¼‰
- `chromadb` - å‘é‡æ•°æ®åº“ï¼ˆæ— éœ€é¢å¤–é…ç½®ï¼Œè‡ªåŠ¨å®‰è£…ï¼‰
- `flask` - Webæ¡†æž¶ï¼ˆç”¨äºŽWebç•Œé¢ï¼‰
- `flask-cors` - è·¨åŸŸæ”¯æŒ
- `pillow` - å›¾ç‰‡å¤„ç†åº“
- å…¶ä»–å¿…è¦çš„ä¾èµ–åŒ…

**æ³¨æ„**ï¼šchromadb å·²åŒ…å«åœ¨ requirements.txt ä¸­ï¼Œè¿è¡Œä¸Šè¿°å‘½ä»¤å³å¯è‡ªåŠ¨å®‰è£…ï¼Œä¸éœ€è¦å•ç‹¬å®‰è£…ã€‚

### å¸¸è§é—®é¢˜

#### protobuf ç‰ˆæœ¬å†²çª

å¦‚æžœé‡åˆ° `AttributeError: 'MessageFactory' object has no attribute 'GetPrototype'` é”™è¯¯ï¼Œè¿™æ˜¯å› ä¸º protobuf ç‰ˆæœ¬è¿‡æ–°å¯¼è‡´çš„ã€‚è§£å†³æ–¹æ³•ï¼š

```bash
pip install "protobuf>=3.20.0,<4.25.0" --force-reinstall
```

æˆ–è€…é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ–ï¼š

```bash
pip install -r requirements.txt --force-reinstall
```

## ä½¿ç”¨æ–¹æ³•

### 1. ç´¢å¼•å›¾ç‰‡

é¦–å…ˆéœ€è¦å°†å›¾ç‰‡ç›®å½•ä¸­çš„å›¾ç‰‡ç¼–ç ä¸ºå‘é‡å¹¶å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼š

```bash
python main.py index --image_dir ./images
```

æˆ–è€…æŒ‡å®šè‡ªå®šä¹‰çš„æ•°æ®åº“ç›®å½•ï¼š

```bash
python main.py index --image_dir ./images --db_dir ./my_db
```

### 2. æœç´¢å›¾ç‰‡

#### ðŸŒ Webç•Œé¢æœç´¢ï¼ˆæŽ¨èï¼‰

å¯åŠ¨WebæœåŠ¡å™¨ï¼Œåœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨å›¾å½¢ç•Œé¢æœç´¢ï¼š

```bash
python app.py
```

ç„¶åŽåœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š`http://localhost:5001`

**Webç•Œé¢åŠŸèƒ½ï¼š**
- ðŸŽ¨ ç¾Žè§‚çš„çŽ°ä»£åŒ–ç•Œé¢
- ðŸ” å®žæ—¶æœç´¢ç»“æžœæ˜¾ç¤º
- ðŸ“Š æ˜¾ç¤ºç›¸ä¼¼åº¦åˆ†æ•°
- ðŸ–¼ï¸ å›¾ç‰‡é¢„è§ˆå’Œç‚¹å‡»æŸ¥çœ‹
- ðŸ“± å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨è®¾å¤‡

#### å‘½ä»¤è¡Œæœç´¢

##### å•æ¬¡æœç´¢

```bash
python main.py search --query "ä¸€åªçŒ«" --top_k 5
```

##### äº¤äº’å¼æœç´¢

è¿›å…¥äº¤äº’å¼æœç´¢æ¨¡å¼ï¼Œå¯ä»¥è¿žç»­è¾“å…¥å¤šä¸ªæŸ¥è¯¢ï¼š

```bash
python main.py interactive
```

åœ¨äº¤äº’æ¨¡å¼ä¸‹ï¼š
- è¾“å…¥æœç´¢å…³é”®è¯è¿›è¡Œæœç´¢
- è¾“å…¥ `quit`ã€`exit` æˆ– `q` é€€å‡º

## ç¤ºä¾‹

```bash
# 1. ç´¢å¼•å›¾ç‰‡
python main.py index --image_dir ./my_images

# 2. pass


# 3. å¯åŠ¨Webç•Œé¢ï¼ˆæŽ¨èï¼‰
python app.py
# ç„¶åŽåœ¨æµè§ˆå™¨è®¿é—® http://localhost:5001

# 4. æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œæœç´¢
python main.py search --query "çº¢è‰²çš„æ±½è½¦"

# 5. äº¤äº’å¼æœç´¢
python main.py interactive
```

## é¡¹ç›®ç»“æž„

```
vector_db_demo/
â”œâ”€â”€ app.py               # WebæœåŠ¡å™¨ï¼ˆFlaskï¼‰
â”œâ”€â”€ main.py              # å‘½ä»¤è¡Œä¸»ç¨‹åºå…¥å£
â”œâ”€â”€ image_indexer.py     # å›¾ç‰‡ç´¢å¼•æ¨¡å—
â”œâ”€â”€ image_searcher.py    # å›¾ç‰‡æœç´¢æ¨¡å—
â”œâ”€â”€ templates/           # HTMLæ¨¡æ¿ç›®å½•
â”‚   â””â”€â”€ index.html      # æœç´¢ç•Œé¢
â”œâ”€â”€ requirements.txt     # ä¾èµ–åŒ…
â”œâ”€â”€ README.md           # è¯´æ˜Žæ–‡æ¡£
â””â”€â”€ chroma_db/          # å‘é‡æ•°æ®åº“ç›®å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
```

## æŠ€æœ¯è¯´æ˜Ž

- **CLIPæ¨¡åž‹**: ä½¿ç”¨OpenAIçš„CLIPæ¨¡åž‹ï¼ˆ`openai/clip-vit-base-patch32`ï¼‰è¿›è¡Œå›¾ç‰‡å’Œæ–‡å­—çš„å‘é‡ç¼–ç 
- **å‘é‡æ•°æ®åº“**: ä½¿ç”¨Chromaçš„`PersistentClient`è¿›è¡Œå‘é‡å­˜å‚¨å’Œç›¸ä¼¼åº¦æœç´¢
- **æ•°æ®æŒä¹…åŒ–**: æ‰€æœ‰å‘é‡æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ç£ç›˜ï¼ˆé»˜è®¤`./chroma_db`ç›®å½•ï¼‰ï¼Œç¨‹åºé‡å¯åŽæ•°æ®ä¾ç„¶ä¿ç•™
- **ç›¸ä¼¼åº¦è®¡ç®—**: ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦è¿›è¡Œå›¾ç‰‡å’Œæ–‡å­—å‘é‡çš„åŒ¹é…

## æ³¨æ„äº‹é¡¹

1. é¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ä¸‹è½½CLIPæ¨¡åž‹ï¼Œéœ€è¦ç½‘ç»œè¿žæŽ¥
2. å¦‚æžœä½¿ç”¨GPUï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨CUDAåŠ é€Ÿ
3. å›¾ç‰‡æ ¼å¼æ”¯æŒ: jpg, jpeg, png, bmp, gif, webp
4. **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨`PersistentClient`ï¼Œæ‰€æœ‰å‘é‡æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ç£ç›˜ï¼Œç¨‹åºé‡å¯åŽæ•°æ®ä¾ç„¶ä¿ç•™ï¼Œæ— éœ€é‡æ–°ç´¢å¼•
5. æ•°æ®åº“ç›®å½•ï¼ˆé»˜è®¤`./chroma_db`ï¼‰å¯ä»¥å¤‡ä»½å’Œè¿ç§»ï¼Œåªéœ€å¤åˆ¶æ•´ä¸ªç›®å½•å³å¯

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

- ä½¿ç”¨GPUå¯ä»¥æ˜¾è‘—åŠ é€Ÿå‘é‡ç¼–ç è¿‡ç¨‹
- å¯¹äºŽå¤§é‡å›¾ç‰‡ï¼Œå¯ä»¥åˆ†æ‰¹ç´¢å¼•
- è°ƒæ•´ `top_k` å‚æ•°å¯ä»¥æŽ§åˆ¶è¿”å›žç»“æžœæ•°é‡

